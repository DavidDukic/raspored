<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Raspored PWA</title>

<link rel="manifest" href="manifest.json">

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#f6f7fb;
}

.container{max-width:1300px;margin:auto;padding:16px}
h1{text-align:center}

.wrapper{overflow-x:auto}
table{border-collapse:collapse;width:100%;background:white}

th,td{
 border:1px solid #e5e7eb;
 min-width:140px;
 height:65px;
 vertical-align:top;
 position:relative;
 overflow:visible;
}

th{background:#4f46e5;color:white;font-size:17px}
.time{background:#eef2ff;font-weight:600;text-align:center;font-size:15px}

.event{
 font-size:15px;
 font-weight:600;
 display:flex;
 align-items:center;
 justify-content:center;
 text-align:center;
 border-radius:14px;
 box-shadow:0 6px 16px rgba(0,0,0,.12);
 color:white;
 position:absolute;
 left:2px;
 right:2px;
 cursor:grab;
 z-index:10;
}

.predavanje{background:#4f46e5}
.av{background:#059669}
.lab{background:#ea580c}

.close{position:absolute;right:4px;top:2px;font-size:11px;cursor:pointer}

.controls{
 margin:10px 0;
 padding:10px;
 background:white;
 border-radius:12px;
 display:flex;
 gap:6px;
 flex-wrap:wrap
}

button{
 padding:8px 12px;
 border:none;
 border-radius:8px;
 background:#4f46e5;
 color:white;
 cursor:pointer
}

.tooltip{
 position:fixed;
 background:#111827;
 color:white;
 padding:10px;
 border-radius:10px;
 font-size:13px;
 pointer-events:none;
 opacity:0;
 transition:.15s;
 z-index:9999;
}

.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4);
 display:none;
 align-items:center;
 justify-content:center
}

.modalContent{
 background:white;
 padding:16px;
 border-radius:12px;
 width:320px;
 display:flex;
 flex-direction:column;
 gap:8px
}

.modalContent input,.modalContent select{
 padding:8px;
 border-radius:8px;
 border:1px solid #ddd
}
</style>
</head>

<body>

<div class="container">
<h1>ðŸ“… Raspored</h1>

<div class="controls">
<button onclick="openModal()">âž• Dodaj</button>
<button onclick="undo()">â†© Undo</button>
<button onclick="bulkImport()">âš¡ Import raspored</button>
</div>

<div class="wrapper"><table id="table"></table></div>
</div>

<div id="tooltip" class="tooltip"></div>

<div class="modal" id="modal">
<div class="modalContent">
<input id="mSubject" placeholder="Predmet">
<select id="mType">
<option value="predavanje">Predavanje</option>
<option value="av">AV</option>
<option value="lab">LAB</option>
</select>
<select id="mDay"></select>
<input id="mStart" placeholder="Start HH:MM">
<input id="mEnd" placeholder="End HH:MM">
<input id="mRoom" placeholder="UÄionica">
<button onclick="addEvent()">Spremi</button>
<button onclick="closeModal()">Zatvori</button>
</div>
</div>

<script type="module">

const parse=t=>{let[h,m]=t.split(":");return +h*60+ +m};
const overlaps=(e,s)=>e.startMin<s.end&&e.endMin>s.start;

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyDsyWQzqe1O0osgScAzYl780hADLuZ0pn0",
 authDomain:"raspored-d6237.firebaseapp.com",
 projectId:"raspored-d6237",
 storageBucket:"raspored-d6237.firebasestorage.app",
 messagingSenderId:"807623139498",
 appId:"1:807623139498:web:d174a1032f3a4df57ab0d3"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const scheduleRef=doc(db,"schedule","main");

const CELL_HEIGHT=65;
const days=["Ponedjeljak","Utorak","Srijeda","ÄŒetvrtak","Petak","Subota"];
const slots=[
{label:"9:00-9:45",start:540,end:585},{label:"9:50-10:35",start:590,end:635},
{label:"10:45-11:30",start:645,end:690},{label:"11:35-12:20",start:695,end:740},
{label:"12:30-13:15",start:750,end:795},{label:"13:20-14:05",start:800,end:845},
{label:"14:15-15:00",start:855,end:900},{label:"15:05-15:50",start:905,end:950},
{label:"16:00-16:45",start:960,end:1005},{label:"16:50-17:35",start:1010,end:1055},
{label:"17:45-18:30",start:1065,end:1110},{label:"18:35-19:20",start:1115,end:1160},
{label:"19:30-20:15",start:1170,end:1215},{label:"20:15-20:45",start:1215,end:1245}
];

let state=[];
let history=[];

const modal=document.getElementById("modal");
const mSubject=document.getElementById("mSubject");
const mType=document.getElementById("mType");
const mDay=document.getElementById("mDay");
const mStart=document.getElementById("mStart");
const mEnd=document.getElementById("mEnd");
const mRoom=document.getElementById("mRoom");

const save=()=>setDoc(scheduleRef,{events:state});

onSnapshot(scheduleRef,snap=>{
 if(snap.exists()){
  state=snap.data().events||[];
  build();
 }
});

function build(){
 const t=document.getElementById("table");
 t.innerHTML="<tr><th>Vrijeme</th>"+days.map(d=>`<th>${d}</th>`).join("")+"</tr>";

 slots.forEach(s=>{
  let r=`<tr><td class=time>${s.label}</td>`;
  days.forEach(d=>r+=`<td data-day="${d}" data-slot="${s.label}"></td>`);
  t.innerHTML+=r+"</tr>";
 });

 enableDropZones();
 render();
}

function render(){

 const tooltip=document.getElementById("tooltip");

 state.forEach((e,i)=>{

  const covered=slots.filter(slot=>e.day&&overlaps(e,slot));
  if(!covered.length)return;

  const first=covered[0];
  const cell=[...document.querySelectorAll("td[data-day]")]
   .find(td=>td.dataset.day===e.day&&td.dataset.slot===first.label);
  if(!cell)return;

  const div=document.createElement("div");
  div.className="event "+e.type;
  div.draggable=true;

  const duration=e.endMin-e.startMin;
  const pxPerMin=CELL_HEIGHT/(slots[0].end-slots[0].start);
  div.style.height=(duration*pxPerMin-6)+"px";
  div.style.top=((e.startMin-first.start)*pxPerMin)+"px";

  div.onmouseenter=()=>{
   tooltip.style.opacity=1;
   tooltip.innerHTML=`<b>${e.subject}</b><br>${e.room}<br>${e.start}-${e.end}`;
   const r=div.getBoundingClientRect();
   tooltip.style.left=r.right+10+"px";
   tooltip.style.top=r.top+"px";
  };
  div.onmouseleave=()=>tooltip.style.opacity=0;

  div.onclick=()=>alert(`${e.subject}\n${e.room}\n${e.start}-${e.end}`);

  div.ondragstart=ev=>ev.dataTransfer.setData("i",i);

  div.innerHTML=`<div class="close">âœ•</div>${e.subject}`;
  div.querySelector(".close").onclick=(ev)=>{
   ev.stopPropagation();
   history.push(JSON.stringify(state));
   state.splice(i,1);
   save();
  };

  cell.appendChild(div);
 });
}

function enableDropZones(){
 document.querySelectorAll("td[data-day]").forEach(td=>{
  td.ondragover=e=>e.preventDefault();
  td.ondrop=e=>{
   const i=e.dataTransfer.getData("i");
   const day=td.dataset.day;
   const slot=slots.find(s=>s.label===td.dataset.slot);
   const dur=state[i].endMin-state[i].startMin;

   history.push(JSON.stringify(state));

   state[i].day=day;
   state[i].startMin=slot.start;
   state[i].endMin=slot.start+dur;
   state[i].start=`${Math.floor(state[i].startMin/60)}:${(state[i].startMin%60).toString().padStart(2,"0")}`;
   state[i].end=`${Math.floor(state[i].endMin/60)}:${(state[i].endMin%60).toString().padStart(2,"0")}`;

   save();
  };
 });
}

window.addEvent=()=>{
 history.push(JSON.stringify(state));
 state.push({
  subject:mSubject.value,type:mType.value,day:mDay.value,start:mStart.value,end:mEnd.value,room:mRoom.value,
  startMin:parse(mStart.value),endMin:parse(mEnd.value)
 });
 save();closeModal();
};

window.bulkImport=()=>{
 const data=[
 {subject:"Linux",type:"lab",day:"Srijeda",start:"17:45",end:"19:20",room:"210"},
 {subject:"PMA",type:"lab",day:"ÄŒetvrtak",start:"17:45",end:"19:20",room:"109"},
 {subject:"RaÄunalne mreÅ¾e",type:"lab",day:"ÄŒetvrtak",start:"13:20",end:"15:00",room:"202"},
 {subject:"MatematiÄka analiza",type:"av",day:"Srijeda",start:"16:00",end:"17:35",room:"101"}
 ].map(e=>({...e,startMin:parse(e.start),endMin:parse(e.end)}));

 data.forEach(n=>{
  if(!state.some(e=>e.subject===n.subject&&e.day===n.day&&e.startMin===n.startMin)) state.push(n);
 });

 save();
};

window.openModal=()=>modal.style.display="flex";
window.closeModal=()=>modal.style.display="none";
window.undo=()=>{if(history.length){state=JSON.parse(history.pop());save();}};

days.forEach(d=>mDay.add(new Option(d,d)));

build();

</script>
</body>
</html>