<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raspored PWA</title>

<link rel="manifest" href="manifest.json">

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#f6f7fb;
 -webkit-tap-highlight-color:transparent;
}

.container{max-width:1300px;margin:auto;padding:16px}
h1{text-align:center}

.wrapper{overflow-x:auto}
table{border-collapse:collapse;width:100%;background:white}

th,td{
 border:1px solid #e5e7eb;
 min-width:140px;
 height:65px;
 vertical-align:top;
 position:relative;
}

th{
 background:#4f46e5;
 color:white;
 font-size:17px;
}

.time{
 background:#eef2ff;
 font-weight:600;
 text-align:center;
 font-size:15px;
}

.event{
 font-size:15px;
 font-weight:600;
 display:flex;
 align-items:center;
 justify-content:center;
 text-align:center;
 border-radius:14px;
 box-shadow:0 6px 16px rgba(0,0,0,.12);
 transition:.15s;
 color:white;
 position:absolute;
 left:2px;
 right:2px;
 cursor:grab;
}

.event:active{transform:scale(.97)}

.predavanje{background:#4f46e5}
.av{background:#059669}
.lab{background:#ea580c}

.close{
 position:absolute;
 right:4px;
 top:2px;
 font-size:11px;
 cursor:pointer;
}

.controls{
 margin:10px 0;
 padding:10px;
 background:white;
 border-radius:12px;
 display:flex;
 gap:6px;
 flex-wrap:wrap
}

button{
 padding:8px 12px;
 border:none;
 border-radius:8px;
 background:#4f46e5;
 color:white;
 cursor:pointer
}

.legend{display:flex;gap:10px;margin-top:10px}
.badge{padding:6px 10px;border-radius:8px;color:white}

.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4);
 display:none;
 align-items:center;
 justify-content:center
}

.modalContent{
 background:white;
 padding:16px;
 border-radius:12px;
 width:320px;
 display:flex;
 flex-direction:column;
 gap:8px
}

.modalContent input,.modalContent select{
 padding:8px;
 border-radius:8px;
 border:1px solid #ddd
}
</style>
</head>

<body>

<div class="container">
<h1>ðŸ“… Raspored</h1>

<div id="nextClass" style="margin-bottom:10px;font-weight:600;font-size:18px;color:#4f46e5"></div>

<div class="controls">
<button onclick="openModal()">âž• Dodaj</button>
<button onclick="undo()">â†© Undo</button>
<button onclick="bulkImport()">âš¡ Import raspored</button>
<button onclick="enableNotifications()">ðŸ”” Notifikacije</button>
</div>

<div class="wrapper"><table id="table"></table></div>

<div class="legend">
<div class="badge predavanje">Predavanje</div>
<div class="badge av">Auditorne</div>
<div class="badge lab">Laboratorij</div>
</div>

</div>

<div class="modal" id="modal">
<div class="modalContent">
<input id="mSubject" placeholder="Predmet">
<select id="mType">
<option value="predavanje">Predavanje</option>
<option value="av">AV</option>
<option value="lab">LAB</option>
</select>
<select id="mDay"></select>
<input id="mStart" placeholder="Start HH:MM">
<input id="mEnd" placeholder="End HH:MM">
<input id="mRoom" placeholder="UÄionica">
<button onclick="addEvent()">Spremi</button>
<button onclick="closeModal()">Zatvori</button>
</div>
</div>

<script type="module">

const parse = t => { let [h,m]=t.split(":"); return +h*60 + +m };
const overlaps = (e,s) => e.startMin < s.end && e.endMin > s.start;

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyDsyWQzqe1O0osgScAzYl780hADLuZ0pn0",
 authDomain:"raspored-d6237.firebaseapp.com",
 projectId:"raspored-d6237",
 storageBucket:"raspored-d6237.firebasestorage.app",
 messagingSenderId:"807623139498",
 appId:"1:807623139498:web:d174a1032f3a4df57ab0d3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const scheduleRef = doc(db,"schedule","main");

/* APP */
const CELL_HEIGHT = 65;
const days=["Ponedjeljak","Utorak","Srijeda","ÄŒetvrtak","Petak","Subota"];
const slots=[
{label:"9:00-9:45",start:540,end:585},{label:"9:50-10:35",start:590,end:635},
{label:"10:45-11:30",start:645,end:690},{label:"11:35-12:20",start:695,end:740},
{label:"12:30-13:15",start:750,end:795},{label:"13:20-14:05",start:800,end:845},
{label:"14:15-15:00",start:855,end:900},{label:"15:05-15:50",start:905,end:950},
{label:"16:00-16:45",start:960,end:1005},{label:"16:50-17:35",start:1010,end:1055},
{label:"17:45-18:30",start:1065,end:1110},{label:"18:35-19:20",start:1115,end:1160},
{label:"19:30-20:15",start:1170,end:1215},{label:"20:15-20:45",start:1215,end:1245}
];

let state=[];
const cached=localStorage.getItem("offlineSched");
if(cached){
 state = JSON.parse(cached);
}

let history=[];
const modal = document.getElementById("modal");
const mSubject = document.getElementById("mSubject");
const mType = document.getElementById("mType");
const mDay = document.getElementById("mDay");
const mStart = document.getElementById("mStart");
const mEnd = document.getElementById("mEnd");
const mRoom = document.getElementById("mRoom");
let scheduled=new Set();

window.enableNotifications = async () => {
 if(Notification.permission === "default"){
  await Notification.requestPermission();
 }
 alert("Notifikacije ukljuÄene ðŸ‘");
};

function scheduleNotifications(){
 const now=new Date();

 state.forEach(e=>{
  const dayIndex=days.indexOf(e.day);
  if(dayIndex===-1)return;

  const target=new Date();
  const diff=(dayIndex-target.getDay()+7)%7;
  target.setDate(target.getDate()+diff);
  target.setHours(Math.floor(e.startMin/60));
  target.setMinutes(e.startMin%60);

  const notifyTime=new Date(target.getTime()-60*60*1000);
  const key=e.subject+notifyTime.getTime();
  if(scheduled.has(key))return;

  const delay=notifyTime-now;
  if(delay>0){
   scheduled.add(key);
   setTimeout(()=>{
    if(Notification.permission==="granted"){
     new Notification("ðŸ“š Predavanje uskoro",{body:`${e.subject} u ${e.start}`,icon:"ikona.png"});
    }
   },delay);
  }
 });
}

/* FIRESTORE LISTENER */
onSnapshot(scheduleRef,snap=>{
 if(snap.exists()){
  state=snap.data().events||[];
  localStorage.setItem("offlineSched",JSON.stringify(state));
  build();
  scheduleNotifications();
 }
});

/* BUILD */
function build(){
 const t=document.getElementById("table");
 t.innerHTML="<tr><th>Vrijeme</th>"+days.map(d=>`<th>${d}</th>`).join("")+"</tr>";

 slots.forEach(s=>{
  let r=`<tr><td class=time>${s.label}</td>`;
  days.forEach(d=>r+=`<td data-day="${d}" data-slot="${s.label}"></td>`);
  t.innerHTML+=r+"</tr>";
 });

 render();
 updateNextClass();
}

/* RENDER */
function render(){
 state.forEach((e,i)=>{
  const covered=slots.filter(slot=>e.day&&overlaps(e,slot));
  if(!covered.length)return;

  const first=covered[0];
  const cell=[...document.querySelectorAll("td[data-day]")]
   .find(td=>td.dataset.day===e.day&&td.dataset.slot===first.label);
  if(!cell)return;

  const div=document.createElement("div");
  div.className="event "+e.type;

  const duration=e.endMin-e.startMin;
  const slotMinutes=slots[0].end-slots[0].start;
  const pxPerMin=CELL_HEIGHT/slotMinutes;

  div.style.height=(duration*pxPerMin-6)+"px";
  const offset=(e.startMin-first.start)*pxPerMin;
  div.style.top=offset+"px";

  div.innerHTML=`<div class="close">âœ•</div>${e.subject}`;
  div.querySelector(".close").onclick=()=>{state.splice(i,1);save();};

  cell.appendChild(div);
 });
}

/* SAVE */
const save = () => {

 if(!state.length){
   alert("âš ï¸ Prazan raspored â€” save blokiran");
   return;
 }

 setDoc(scheduleRef,{events:state});
}

/* NEXT CLASS */
function updateNextClass(){
 const nowMin=new Date().getHours()*60+new Date().getMinutes();
 const todayIndex = new Date().getDay()-1;
 const today = todayIndex >= 0 ? days[todayIndex] : null;
 const next=state.filter(e=>e.day===today&&e.startMin>nowMin).sort((a,b)=>a.startMin-b.startMin)[0];
 document.getElementById("nextClass").innerText=next?"âž¡ï¸ SljedeÄ‡e: "+next.subject+" u "+next.start:"";
}

/* CRUD */
window.addEvent=()=>{
 state.push({
  subject:mSubject.value,type:mType.value,day:mDay.value,start:mStart.value,end:mEnd.value,room:mRoom.value,
  startMin:parse(mStart.value),endMin:parse(mEnd.value)
 });
 save();closeModal();
};

window.bulkImport = () => {

 const newEvents = [

 {subject:"MatematiÄka analiza",type:"predavanje",day:"Ponedjeljak",start:"18:35",end:"20:45",room:"113"},
 {subject:"MatematiÄka analiza",type:"av",day:"Srijeda",start:"16:00",end:"16:45",room:"101"},
 {subject:"Fizika u raÄunarstvu",type:"lab",day:"Ponedjeljak",start:"9:00",end:"10:30",room:"004 I"},
 {subject:"Fizika u raÄunarstvu",type:"predavanje",day:"Utorak",start:"9:00",end:"11:30",room:"107"},
 {subject:"PMA",type:"predavanje",day:"Petak",start:"10:45",end:"13:15",room:"104"},
 {subject:"PMA",type:"lab",day:"ÄŒetvrtak",start:"17:45",end:"18:30",room:"109"},
 {subject:"TehniÄki engleski",type:"av",day:"Srijeda",start:"10:45",end:"12:20",room:"106"},
 {subject:"TehniÄki engleski",type:"av",day:"ÄŒetvrtak",start:"9:50",end:"11:30",room:"106"},
 {subject:"RaÄunalne mreÅ¾e",type:"predavanje",day:"Utorak",start:"13:20",end:"14:05",room:"107"},
 {subject:"Linux",type:"lab",day:"Srijeda",start:"17:45",end:"18:30",room:"210"},
 {subject:"RaÄunalne mreÅ¾e",type:"lab",day:"ÄŒetvrtak",start:"13:00",end:"14:30",room:"202"}

 ].map(e=>({
  ...e,
  startMin:parse(e.start),
  endMin:parse(e.end)
 }));


 // â­ MERGE bez duplikata
 newEvents.forEach(ne => {

  const exists = state.some(se =>
    se.subject===ne.subject &&
    se.day===ne.day &&
    se.start===ne.start
  );

  if(!exists){
   state.push(ne);
  }

 });

 save();
};

window.openModal=()=>modal.style.display="flex";
window.closeModal=()=>modal.style.display="none";
window.undo=()=>{if(history.length){state=JSON.parse(history.pop());save();}};

days.forEach(d=>mDay.add(new Option(d,d)));

build();
</script>
</body>
</html>